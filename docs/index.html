<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•çƒå‹•ä½œåˆ†æç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #4fc3f7;
            font-size: 1.5rem;
        }

        .server-config {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .server-config input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
        }

        .server-config input::placeholder {
            color: #888;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }

        .upload-area.dragover {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.2);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        #fileInput {
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        #videoPlayer {
            width: 100%;
            border-radius: 10px;
            background: #000;
        }

        .time-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .time-input-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }

        .time-input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #81d4fa;
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .time-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 5px;
            min-width: 120px;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4fc3f7, #0288d1);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #66bb6a, #43a047);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 187, 106, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            color: #fff;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 167, 38, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .current-time-display {
            text-align: center;
            margin-top: 15px;
            font-size: 1.2rem;
        }

        .current-time-display span {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 5px;
        }

        .process-section {
            text-align: center;
            margin-top: 20px;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #0288d1);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            display: block;
            background: rgba(102, 187, 106, 0.3);
            border: 1px solid #66bb6a;
        }

        .status-message.error {
            display: block;
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        .status-message.info {
            display: block;
            background: rgba(79, 195, 247, 0.3);
            border: 1px solid #4fc3f7;
        }

        .results-section {
            display: none;
        }

        .results-list {
            list-style: none;
            padding: 0;
        }

        .results-list li {
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .results-list a {
            color: #4fc3f7;
            text-decoration: none;
        }

        .results-list a:hover {
            text-decoration: underline;
        }

        .timeline-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .timeline {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
        }

        .timeline-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 3px;
            cursor: grab;
        }

        .timeline-marker.start {
            background: #66bb6a;
        }

        .timeline-marker.end {
            background: #f44336;
        }

        .timeline-selection {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(79, 195, 247, 0.3);
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .keyboard-shortcuts {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .keyboard-shortcuts h3 {
            margin-bottom: 10px;
            color: #81d4fa;
        }

        .keyboard-shortcuts ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px;
        }

        .keyboard-shortcuts kbd {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: rgba(102, 187, 106, 0.3);
            color: #66bb6a;
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        @media (max-width: 768px) {
            .time-controls {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¾ æŠ•çƒå‹•ä½œåˆ†æç³»çµ±</h1>

        <!-- Server Configuration (hidden, using fixed URL) -->
        <input type="hidden" id="serverUrl" value="https://unirritably-unfoul-chere.ngrok-free.app">

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
            <h2>ğŸ“¤ ä¸Šå‚³å½±ç‰‡</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ¬</div>
                <p>é»æ“Šæˆ–æ‹–æ”¾å½±ç‰‡æª”æ¡ˆåˆ°é€™è£¡</p>
                <p style="color: #888; margin-top: 10px;">æ”¯æ´æ ¼å¼: MP4, AVI, MOV, MKV, WebM</p>
                <input type="file" id="fileInput" accept="video/*">
            </div>
        </div>

        <!-- Video Player Section -->
        <div class="card" id="videoSection" style="display: none;">
            <h2>ğŸ¥ å½±ç‰‡é è¦½èˆ‡æ™‚é–“æ¨™è¨˜</h2>
            
            <div class="video-container">
                <video id="videoPlayer" controls></video>
            </div>

            <div class="current-time-display">
                ç›®å‰æ™‚é–“: <span id="currentTimeDisplay">0.000</span> ç§’
            </div>

            <div class="playback-controls">
                <button class="btn btn-small btn-primary" onclick="seekRelative(-5)">âª -5s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(-1)">â—€ -1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(-0.1)">â— -0.1s</button>
                <button class="btn btn-small btn-primary" onclick="togglePlay()">â¯ æ’­æ”¾/æš«åœ</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(0.1)">â–· +0.1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(1)">â–¶ +1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(5)">â© +5s</button>
            </div>

            <div class="playback-controls">
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(0.25)">0.25x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(0.5)">0.5x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(1)">1x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(2)">2x</button>
            </div>

            <div class="time-controls">
                <div class="time-input-group">
                    <label>ğŸ¦µ æŠ¬è…³æ™‚é–“ (é–‹å§‹)</label>
                    <div class="time-display">
                        <span class="time-value" id="startTimeValue">æœªè¨­å®š</span>
                        <button class="btn btn-success" onclick="setStartTime()">è¨­å®šç›®å‰æ™‚é–“</button>
                    </div>
                </div>
                <div class="time-input-group">
                    <label>âš¾ çƒé›¢æ‰‹æ™‚é–“ (çµæŸ)</label>
                    <div class="time-display">
                        <span class="time-value" id="endTimeValue">æœªè¨­å®š</span>
                        <button class="btn btn-warning" onclick="setEndTime()">è¨­å®šç›®å‰æ™‚é–“</button>
                    </div>
                </div>
            </div>

            <div class="timeline-container">
                <div class="timeline" id="timeline">
                    <div class="timeline-selection" id="timelineSelection"></div>
                    <div class="timeline-marker start" id="startMarker" style="display: none;"></div>
                    <div class="timeline-marker end" id="endMarker" style="display: none;"></div>
                </div>
                <div class="timeline-labels">
                    <span>0:00</span>
                    <span id="durationLabel">0:00</span>
                </div>
            </div>

            <div class="keyboard-shortcuts">
                <h3>âŒ¨ï¸ å¿«æ·éµ</h3>
                <ul>
                    <li><kbd>Space</kbd> æ’­æ”¾/æš«åœ</li>
                    <li><kbd>â†</kbd> å¾Œé€€ 1 ç§’</li>
                    <li><kbd>â†’</kbd> å‰é€² 1 ç§’</li>
                    <li><kbd>S</kbd> è¨­å®šæŠ¬è…³æ™‚é–“</li>
                    <li><kbd>E</kbd> è¨­å®šçƒé›¢æ‰‹æ™‚é–“</li>
                    <li><kbd>,</kbd> å¾Œé€€ 0.1 ç§’</li>
                    <li><kbd>.</kbd> å‰é€² 0.1 ç§’</li>
                </ul>
            </div>

            <div class="process-section">
                <button class="btn btn-success" id="processBtn" onclick="processVideo()" disabled>
                    ğŸš€ é–‹å§‹åˆ†æ
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    <div class="progress-text" id="progressText">è™•ç†ä¸­...</div>
                </div>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>

        <!-- Results Section -->
        <div class="card results-section" id="resultsSection">
            <h2>ğŸ“Š åˆ†æçµæœ</h2>
            <div class="results-grid">
                <div>
                    <h3>AlphaPose è¼¸å‡º</h3>
                    <ul class="results-list" id="alphaposeResults"></ul>
                </div>
                <div>
                    <h3>MotionBERT è¼¸å‡º</h3>
                    <ul class="results-list" id="motionbertResults"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFilename = null;
        let startTime = null;
        let endTime = null;
        const video = document.getElementById('videoPlayer');

        function getServerUrl() {
            return document.getElementById('serverUrl').value.replace(/\/$/, '');
        }

        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const response = await fetch(`${getServerUrl()}/`, { mode: 'cors' });
                if (response.ok) {
                    statusEl.textContent = 'å·²é€£ç·š âœ“';
                    statusEl.className = 'connection-status connected';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                statusEl.textContent = 'é€£ç·šå¤±æ•— âœ—';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('video', file);

            showStatus('info', 'æ­£åœ¨ä¸Šå‚³å½±ç‰‡...');

            try {
                const response = await fetch(`${getServerUrl()}/upload`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });

                const data = await response.json();

                if (data.success) {
                    uploadedFilename = data.filename;
                    video.src = `${getServerUrl()}/uploads/${data.filename}`;
                    document.getElementById('videoSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'none';
                    showStatus('success', 'å½±ç‰‡ä¸Šå‚³æˆåŠŸï¼è«‹æ¨™è¨˜æŠ¬è…³å’Œçƒé›¢æ‰‹çš„æ™‚é–“é»ã€‚');
                } else {
                    showStatus('error', `ä¸Šå‚³å¤±æ•—: ${data.error}`);
                }
            } catch (error) {
                showStatus('error', `ä¸Šå‚³éŒ¯èª¤: ${error.message}`);
            }
        }

        // Video controls
        video.addEventListener('timeupdate', () => {
            document.getElementById('currentTimeDisplay').textContent = video.currentTime.toFixed(3);
            updateTimeline();
        });

        video.addEventListener('loadedmetadata', () => {
            const duration = video.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            document.getElementById('durationLabel').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });

        function togglePlay() {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function seekRelative(seconds) {
            video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
        }

        function setPlaybackRate(rate) {
            video.playbackRate = rate;
        }

        function setStartTime() {
            startTime = video.currentTime;
            document.getElementById('startTimeValue').textContent = startTime.toFixed(3) + 's';
            document.getElementById('startMarker').style.display = 'block';
            updateTimeline();
            checkProcessReady();
        }

        function setEndTime() {
            endTime = video.currentTime;
            document.getElementById('endTimeValue').textContent = endTime.toFixed(3) + 's';
            document.getElementById('endMarker').style.display = 'block';
            updateTimeline();
            checkProcessReady();
        }

        function updateTimeline() {
            const duration = video.duration || 1;
            const timeline = document.getElementById('timeline');
            const startMarker = document.getElementById('startMarker');
            const endMarker = document.getElementById('endMarker');
            const selection = document.getElementById('timelineSelection');

            if (startTime !== null) {
                const startPercent = (startTime / duration) * 100;
                startMarker.style.left = `${startPercent}%`;
            }

            if (endTime !== null) {
                const endPercent = (endTime / duration) * 100;
                endMarker.style.left = `${endPercent}%`;
            }

            if (startTime !== null && endTime !== null) {
                const startPercent = (startTime / duration) * 100;
                const endPercent = (endTime / duration) * 100;
                selection.style.left = `${Math.min(startPercent, endPercent)}%`;
                selection.style.width = `${Math.abs(endPercent - startPercent)}%`;
            }
        }

        function checkProcessReady() {
            const processBtn = document.getElementById('processBtn');
            if (startTime !== null && endTime !== null && startTime < endTime) {
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
            }
        }

        // Timeline click to seek
        document.getElementById('timeline').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    seekRelative(-1);
                    break;
                case 'arrowright':
                    e.preventDefault();
                    seekRelative(1);
                    break;
                case 's':
                    setStartTime();
                    break;
                case 'e':
                    setEndTime();
                    break;
                case ',':
                    e.preventDefault();
                    seekRelative(-0.1);
                    break;
                case '.':
                    e.preventDefault();
                    seekRelative(0.1);
                    break;
            }
        });

        async function processVideo() {
            if (startTime === null || endTime === null) {
                showStatus('error', 'è«‹å…ˆè¨­å®šæŠ¬è…³æ™‚é–“å’Œçƒé›¢æ‰‹æ™‚é–“');
                return;
            }

            if (startTime >= endTime) {
                showStatus('error', 'æŠ¬è…³æ™‚é–“å¿…é ˆæ—©æ–¼çƒé›¢æ‰‹æ™‚é–“');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;

            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(10, 'æ­£åœ¨è£å‰ªå½±ç‰‡...');

            try {
                const response = await fetch(`${getServerUrl()}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: uploadedFilename,
                        start_time: startTime,
                        end_time: endTime
                    }),
                    mode: 'cors'
                });

                updateProgress(50, 'æ­£åœ¨é‹è¡Œåˆ†æè…³æœ¬...');

                const data = await response.json();

                if (data.success) {
                    updateProgress(100, 'åˆ†æå®Œæˆï¼');
                    showStatus('success', `âœ… è™•ç†å®Œæˆï¼å½±ç‰‡æ™‚é•·: ${data.duration.toFixed(3)} ç§’`);
                    loadResults();
                } else {
                    showStatus('error', `è™•ç†å¤±æ•—: ${data.error}`);
                }
            } catch (error) {
                showStatus('error', `è™•ç†éŒ¯èª¤: ${error.message}`);
            } finally {
                processBtn.disabled = false;
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = text;
        }

        async function loadResults() {
            try {
                const response = await fetch(`${getServerUrl()}/results`, { mode: 'cors' });
                const data = await response.json();

                document.getElementById('resultsSection').style.display = 'block';

                const alphaposeList = document.getElementById('alphaposeResults');
                alphaposeList.innerHTML = '';
                data.alphapose.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${getServerUrl()}/results/alphapose/${file}" target="_blank">${file}</a>`;
                    alphaposeList.appendChild(li);
                });

                const motionbertList = document.getElementById('motionbertResults');
                motionbertList.innerHTML = '';
                data.motionbert.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${getServerUrl()}/results/motionbert/${file}" target="_blank">${file}</a>`;
                    motionbertList.appendChild(li);
                });
            } catch (error) {
                console.error('Failed to load results:', error);
            }
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message ${type}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
        }

        // Test connection on load
        window.addEventListener('load', testConnection);
    </script>
</body>
</html>
