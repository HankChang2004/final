<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投球動作分析系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* QR Code 右下角固定樣式 */
        .qr-code-corner {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .qr-code-corner img {
            width: 120px;
            height: 120px;
            display: block;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #4fc3f7;
            font-size: 1.5rem;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }

        .upload-area.dragover {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.2);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        #fileInput {
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        #videoPlayer {
            width: 100%;
            border-radius: 10px;
            background: #000;
        }

        .time-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .time-input-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }

        .time-input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #81d4fa;
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-value {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 5px;
            min-width: 120px;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4fc3f7, #0288d1);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #66bb6a, #43a047);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 187, 106, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            color: #fff;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 167, 38, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .current-time-display {
            text-align: center;
            margin-top: 15px;
            font-size: 1.2rem;
        }

        .current-time-display span {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 5px;
        }

        .process-section {
            text-align: center;
            margin-top: 20px;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #0288d1);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            display: block;
            background: rgba(102, 187, 106, 0.3);
            border: 1px solid #66bb6a;
        }

        .status-message.error {
            display: block;
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        .status-message.info {
            display: block;
            background: rgba(79, 195, 247, 0.3);
            border: 1px solid #4fc3f7;
        }

        .timeline-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .timeline {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
        }

        .timeline-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 3px;
            cursor: grab;
        }

        .timeline-marker.start {
            background: #66bb6a;
        }

        .timeline-marker.end {
            background: #f44336;
        }

        .timeline-selection {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(79, 195, 247, 0.3);
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }

        @media (max-width: 768px) {
            .time-controls {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>投球動作分析系統</h1>

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
            <h2>上傳影片</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon"></div>
                <p>點擊或拖放影片檔案到這裡</p>
                <p style="color: #888; margin-top: 10px;">支援格式: MP4, AVI, MOV, MKV, WebM</p>
                <input type="file" id="fileInput" accept="video/*">
            </div>
        </div>

        <!-- Video Player Section -->
        <div class="card" id="videoSection" style="display: none;">
            <h2>影片預覽與時間標記</h2>
            
            <div class="video-container">
                <video id="videoPlayer" controls crossorigin="anonymous"></video>
            </div>

            <div class="current-time-display">
                目前時間: <span id="currentTimeDisplay">0.000</span> 秒
            </div>

            <div class="playback-controls">
                <button class="btn btn-small btn-primary" onclick="seekRelative(-5)">-5s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(-1)">-1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(-0.1)">-0.1s</button>
                <button class="btn btn-small btn-primary" onclick="togglePlay()">播放/暫停</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(0.1)">+0.1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(1)">+1s</button>
                <button class="btn btn-small btn-primary" onclick="seekRelative(5)">+5s</button>
            </div>

            <div class="playback-controls">
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(0.25)">0.25x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(0.5)">0.5x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(1)">1x</button>
                <button class="btn btn-small btn-primary" onclick="setPlaybackRate(2)">2x</button>
            </div>

            <div class="time-controls">
                <div class="time-input-group">
                    <label>抬腳時間 (開始)</label>
                    <div class="time-display">
                        <span class="time-value" id="startTimeValue">未設定</span>
                        <button class="btn btn-success" onclick="setStartTime()">設定目前時間</button>
                    </div>
                </div>
                <div class="time-input-group">
                    <label>球離手時間 (結束)</label>
                    <div class="time-display">
                        <span class="time-value" id="endTimeValue">未設定</span>
                        <button class="btn btn-warning" onclick="setEndTime()">設定目前時間</button>
                    </div>
                </div>
            </div>

            <div class="timeline-container">
                <div class="timeline" id="timeline">
                    <div class="timeline-selection" id="timelineSelection"></div>
                    <div class="timeline-marker start" id="startMarker" style="display: none;"></div>
                    <div class="timeline-marker end" id="endMarker" style="display: none;"></div>
                </div>
                <div class="timeline-labels">
                    <span>0:00</span>
                    <span id="durationLabel">0:00</span>
                </div>
            </div>

            <div class="process-section">
                <button class="btn btn-success" id="processBtn" onclick="processVideo()" disabled>
                    開始分析
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    <div class="progress-text" id="progressText">處理中...</div>
                </div>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <script>
        // 後端 API 位址
        const DEFAULT_API = 'https://unirritably-unfoul-chere.ngrok-free.dev';
        let API_BASE = localStorage.getItem('apiBase') || DEFAULT_API;
        
        let uploadedFilename = null;
        let startTime = null;
        let endTime = null;
        const video = document.getElementById('videoPlayer');

        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('video', file);

            showStatus('info', '正在上傳影片...');

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedFilename = data.filename;
                    
                    // 使用 fetch 載入影片以繞過 ngrok 警告頁面
                    showStatus('info', '正在載入影片...');
                    const videoResponse = await fetch(`${API_BASE}/uploads/${data.filename}`, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    const videoBlob = await videoResponse.blob();
                    const videoUrl = URL.createObjectURL(videoBlob);
                    video.src = videoUrl;
                    
                    document.getElementById('videoSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'none';
                    showStatus('success', '影片上傳成功！請標記抬腳和球離手的時間點。');
                } else {
                    showStatus('error', `上傳失敗: ${data.error}`);
                }
            } catch (error) {
                showStatus('error', `上傳錯誤: ${error.message}`);
            }
        }

        // Video controls
        video.addEventListener('timeupdate', () => {
            document.getElementById('currentTimeDisplay').textContent = video.currentTime.toFixed(3);
            updateTimeline();
        });

        video.addEventListener('loadedmetadata', () => {
            const duration = video.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            document.getElementById('durationLabel').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });

        function togglePlay() {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function seekRelative(seconds) {
            video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
        }

        function setPlaybackRate(rate) {
            video.playbackRate = rate;
        }

        function setStartTime() {
            startTime = video.currentTime;
            document.getElementById('startTimeValue').textContent = startTime.toFixed(3) + 's';
            document.getElementById('startMarker').style.display = 'block';
            updateTimeline();
            checkProcessReady();
        }

        function setEndTime() {
            endTime = video.currentTime;
            document.getElementById('endTimeValue').textContent = endTime.toFixed(3) + 's';
            document.getElementById('endMarker').style.display = 'block';
            updateTimeline();
            checkProcessReady();
        }

        function updateTimeline() {
            const duration = video.duration || 1;
            const timeline = document.getElementById('timeline');
            const startMarker = document.getElementById('startMarker');
            const endMarker = document.getElementById('endMarker');
            const selection = document.getElementById('timelineSelection');

            if (startTime !== null) {
                const startPercent = (startTime / duration) * 100;
                startMarker.style.left = `${startPercent}%`;
            }

            if (endTime !== null) {
                const endPercent = (endTime / duration) * 100;
                endMarker.style.left = `${endPercent}%`;
            }

            if (startTime !== null && endTime !== null) {
                const startPercent = (startTime / duration) * 100;
                const endPercent = (endTime / duration) * 100;
                selection.style.left = `${Math.min(startPercent, endPercent)}%`;
                selection.style.width = `${Math.abs(endPercent - startPercent)}%`;
            }
        }

        function checkProcessReady() {
            const processBtn = document.getElementById('processBtn');
            if (startTime !== null && endTime !== null && startTime < endTime) {
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
            }
        }

        // Timeline click to seek
        document.getElementById('timeline').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    seekRelative(-1);
                    break;
                case 'arrowright':
                    e.preventDefault();
                    seekRelative(1);
                    break;
                case 's':
                    setStartTime();
                    break;
                case 'e':
                    setEndTime();
                    break;
                case ',':
                    e.preventDefault();
                    seekRelative(-0.1);
                    break;
                case '.':
                    e.preventDefault();
                    seekRelative(0.1);
                    break;
            }
        });

        async function processVideo() {
            if (startTime === null || endTime === null) {
                showStatus('error', '請先設定抬腳時間和球離手時間');
                return;
            }

            if (startTime >= endTime) {
                showStatus('error', '抬腳時間必須早於球離手時間');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;

            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(10, '正在裁剪影片...');

            try {
                const response = await fetch(`${API_BASE}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        filename: uploadedFilename,
                        start_time: startTime,
                        end_time: endTime
                    })
                });

                updateProgress(50, '正在運行分析腳本...');

                const data = await response.json();

                if (data.success) {
                    updateProgress(100, '分析完成！');
                    
                    // 顯示預測結果
                    let resultMessage = `處理完成！影片時長: ${data.duration.toFixed(3)} 秒`;
                    if (data.prediction) {
                        resultMessage += `<br><br><strong>預測球速: ${data.prediction.speed_mph} mph (${data.prediction.speed_kmh} km/h)</strong>`;
                    }
                    showStatus('success', resultMessage, true);
                } else {
                    showStatus('error', `處理失敗: ${data.error}`);
                }
            } catch (error) {
                showStatus('error', `處理錯誤: ${error.message}`);
            } finally {
                processBtn.disabled = false;
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = text;
        }

        function showStatus(type, message, isHtml = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message ${type}`;
            if (isHtml) {
                statusEl.innerHTML = message;
            } else {
                statusEl.textContent = message;
            }
            statusEl.style.display = 'block';
        }
    </script>
    
    <!-- QR Code 右下角固定位置 -->
    <div class="qr-code-corner">
        <img src="images/qrcode.png" alt="QR Code" />
    </div>
</body>
</html>
